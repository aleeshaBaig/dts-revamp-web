<% if current_user.lab_user? %>
    <table id="p_table" class="table table-bordered table-hover listing-tbl">
        <thead>
            <tr>
                <th>Sr No.</th>
                <th>Patient ID</th>
                <th>Lab</th>
                <th>Patient name</th>
                <th>Father/Husband name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>CNIC/Passport</th>
                <th>CNIC Type</th>
                <th>Patient contact</th>
                <th>Guardian's Contact Number</th>
                <th>Entry Date</th>
                <!-- Current Address -->
                <th>Address</th>
                <th>District</th>
                <th>Tehsil</th>
                <th>Uc</th>

                <!-- Permanent Address -->
                <th>Permanent Address</th>
                <th>Permanent District</th>
                <th>Permanent Tehsil</th>
                <th>Permanent UC</th>
                
                <!-- Workplace Address -->
                <th>Workplace Address</th>
                <th>Workplace District</th>
                <th>Workplace Tehsil</th>
                <th>Workplace UC</th>

                <th>Provisional diagnosis</th>
                <th>Reporting date</th>
            </tr>
        </thead>

        <tbody>
            <% @patients.each_with_index do |patient, i| %>
                <tr>
                    <td class="text-center"><%= i + 1 %></td>
                    <td class="text-center"><%= patient.id %></td>
                    <td class="text-left"><%= patient.lab_name %></td>
                    <td class="text-left"><%= patient.patient_name %></td>
                    <td class="text-left"><%= patient.fh_name %></td>
                    <td class="text-center"><%= patient.age %></td>
                    <td class="text-center"><%= patient.gender %></td>
                    <td class="tbl-td-color">
                        <% if patient.p_search_type == 'CNIC'%>
                            <%= patient.cnic %>
                        <% else %>
                            <%= patient.passport %>
                        <% end %>
                    </td>
                    <td class="text-center"><%= patient.cnic_relation %></td>
                    <td class="text-center"><%= patient.patient_contact %></td>
                    <td class="text-center"><%= patient.relation_contact %></td>
                    <td class="text-center"><%= datetime patient.created_at %></td>
                    <!-- Current Address -->
                    <td class="text-left"><%= patient.address %></td>
                    <td class="text-center"><%= patient.district %></td>
                    <td class="text-center"><%= patient.tehsil %></td>
                    <td class="text-center"><%= patient.uc %></td>

                    <!-- Permanent Address -->
                    <td class="text-center"><%= patient.permanent_address %></td>
                    <td class="text-center"><%= patient.permanent_district %></td>
                    <td class="text-center"><%= patient.permanent_tehsil %></td>
                    <td class="text-center"><%= patient.permanent_uc %></td>
                    
                    <!-- Workplace Address -->
                    <td class="text-center"><%= patient.workplace_address %></td>
                    <td class="text-center"><%= patient.workplace_district %></td>
                    <td class="text-center"><%= patient.workplace_tehsil %></td>
                    <td class="text-center"><%= patient.workplace_uc %></td>


                    <td class="text-center"><%= patient.provisional_diagnosis %></td>
                    <td class="text-center"><%= date(patient.reporting_date) rescue nil%></td>
                </tr>
            <% end %>
        </tbody>
    </table>
<% else %>
    <table id="p_table" class="table table-bordered table-hover listing-tbl datatable" width="100%">
        <thead>
            <tr>
                <th>Sr No.</th>
                <th>Patient ID</th>
                <th>Patient name</th>
                <th>Father/Husband name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>CNIC/Passport</th>
                <th>Guardian's Relation</th>
                <th>Patient contact</th>
                <% if @current_user_is_admin %>
                    <th>Updated By</th>
                <% else %>
                    <th>Relation contact</th>
                <% end %>
                <th>Entry Date</th>
                <th>Hospital/Lab</th>
                <% if @is_hospital_district_enable %>
                    <th>Hospital District</th>
                <% end %>
                <th>Address</th>
                <th>District</th>
                <th>Tehsil</th>
                <th>UC</th>
                <th>Residence House Tagged</th>
                <th>Permanent address</th>
                <th>Permanent district</th>
                <th>Permanent tehsil</th>
                <th>Permanent UC</th>
                <th>Permanent House Tagged</th>
                <th>Workplace address</th>
                <th>Workplace district</th>
                <th>Workplace tehsil</th>
                <th>Workplace UC</th>
                <th>Workplace Tagged</th>
                <th>Date of onset</th>
                <th>Fever last for</th>
                <th>Fever</th>
                <th>Previous dengue fever</th>
                <th>Associated Symptoms</th>
                <th>Provisional diagnosis</th>
                <th>Confirmation Date</th>
                <th>Other diagnosed fever</th>
                <th>Patient status</th>
                <th>Patient condition</th>
                <th>Patient outcome</th>
                <th>Reporting Date</th>
                <th>Entered By</th>
                <th>Created By</th>
                <th>Lab Name</th>
                <!-- Lab and Diagnostic Information -->
                <th>NS1</th>
                <th>PCR</th>
                <th>IGG</th>
                <th>IGM</th>
                <th>Advised Test</th>
                <th>Report ordering date</th>
                <th>Report receiving date</th>
            </tr>
        </thead>

        <tbody>
            <% @patients.each_with_index do |patient, i| %>
                <tr style="<%= patient.is_released == true ? 'background-color: #E7FAFF;' : '' %>">
                    <td class="tbl-td-color"><%= i + 1 %></td>
                    <td class="tbl-td-color"><%= patient.id %></td>
                    <td class="tbl-td-color"><%= patient.patient_name %></td>
                    <td class="tbl-td-color"><%= patient.fh_name %></td>
                    <td class="tbl-td-color"><%= patient.age %></td>
                    <td class="tbl-td-color"><%= patient.gender %></td>
                    <td class="tbl-td-color">
                        <% if patient.p_search_type == 'CNIC'%>
                            <%= patient.cnic %>
                        <% else %>
                            <%= patient.passport %>
                        <% end %>
                    </td>
                    <td class="tbl-td-color"><%= patient.cnic_relation %></td>
                    <td class="tbl-td-color"><%= patient.patient_contact %></td>
                     <% if @current_user_is_admin %>
                        <td class="tbl-td-color"><%= patient.updated_by.try(:username) || patient.user.try(:username)  %> </td>
                    <% else %>
                        <td class="tbl-td-color"><%= patient.relation_contact %></td>
                    <% end %>
                    <td class="tbl-td-color"><%= datetime patient.created_at %></td>
                    <td class="tbl-td-color"><%= patient.hospital %></td>
                    <% if @is_hospital_district_enable %>
                        <% hospital_district = patient.hospital.present? ? patient.admitted_hospital.district.try(:district_name) : "NA" %>
                        <td><%= hospital_district %></td>
                    <% end %>
                    <td class="tbl-td-color"><%= patient.address %></td>
                    <td class="tbl-td-color"><%= patient.district %></td>
                    <td class="tbl-td-color"><%= patient.tehsil %></td>
                    <td class="tbl-td-color"><%= patient.uc %></td>
                    <td class="tbl-td-color"><%= patient.residence_tagged %></td>
                    <td class="tbl-td-color"><%= patient.permanent_address %></td>
                    <td class="tbl-td-color"><%= patient.permanent_district %></td>
                    <td class="tbl-td-color"><%= patient.permanent_tehsil %></td>
                    <td class="tbl-td-color"><%= patient.permanent_uc %></td>
                    <td class="tbl-td-color"><%= patient.permanent_residence_tagged %></td>
                    <td class="tbl-td-color"><%= patient.workplace_address %></td>
                    <td class="tbl-td-color"><%= patient.workplace_district %></td>
                    <td class="tbl-td-color"><%= patient.workplace_tehsil %></td>
                    <td class="tbl-td-color"><%= patient.workplace_uc %></td>
                    <td class="tbl-td-color"><%= patient.workplace_tagged %></td>
                    <td class="tbl-td-color"><%= patient.date_of_onset %></td>
                    <td class="tbl-td-color"><%= patient.fever_last_till %></td>
                    <td class="tbl-td-color"><%= patient.fever %></td>
                    <td class="tbl-td-color"><%= patient.previous_dengue_fever %></td>
                    <td class="tbl-td-color"><%= patient.associated_symptom %></td>
                    <td class="tbl-td-color"><%= patient.provisional_diagnosis %></td>
                    <td class="tbl-td-color"><%= datetime patient.confirmation_date %></td>
                    <td class="tbl-td-color"><%= patient.other_diagnosed_fever %></td>
                    <td class="tbl-td-color"><%= patient.patient_status %></td>
                    <td class="tbl-td-color"><%= patient.patient_condition %></td>
                    <td class="tbl-td-color"><%= patient.patient_outcome %></td>
                    <td class="tbl-td-color"><%= patient.reporting_date? ? patient.reporting_date.strftime("%d/%m/%Y") : nil %></td>
                    <td class="tbl-td-color"><%= patient.entered_by %></td>
                    <td class="tbl-td-color"><%= patient.from_lab.try(:username) || patient.user.try(:username) %></td>
                    <td class="tbl-td-color"><%= patient.lab_name.present? ? patient.lab_name : patient.try(:lab_patient).try(:lab).try(:lab_name) %></td>
                    
                    <!-- Lab and Diagnostic Information -->
                    <% lab_result = patient.lab_result %>
                    <% if lab_result.present? and ["Confirmed", "Probable"].include?(patient.provisional_diagnosis) %>
                        <td class="tbl-td-color"><%= lab_result.ns1 %></td>
                        <td class="tbl-td-color"><%= lab_result.pcr %></td>
                        <td class="tbl-td-color"><%= lab_result.igg %></td>
                        <td class="tbl-td-color"><%= lab_result.igm %></td>
                    <% else %>
                        <td align="center">N/A</td>
                        <td align="center">N/A</td>
                        <td align="center">N/A</td>
                        <td align="center">N/A</td>
                    <% end %>

                    <% if lab_result.present? and patient.provisional_diagnosis == "Probable" %>
                        <td class="tbl-td-color"><%= lab_result.advised_test.try(:join, ",") %></td>
                    <% else %>
                        <td align="center">N/A</td>
                    <% end %>
                    
                    <% if lab_result.present? %>
                        <td class="tbl-td-color"><%= lab_result.report_ordering_date.try(:strftime, "%d/%m/%Y") %></td>
                        <td class="tbl-td-color"><%= lab_result.report_receiving_date.try(:strftime, "%d/%m/%Y") %></td>
                    <% else %>
                        <td align="center">N/A</td>
                        <td align="center">N/A</td>
                    <% end %>
                </tr>
            <% end %>
        </tbody>
    </table>
<% end %>
